name: Health Check

on:
  schedule:
    # Corre cada hora
    - cron: '0 * * * *'
  workflow_dispatch: # Permite ejecuciÃ³n manual
  push:
    branches: [ main ]

jobs:
  check-gemini-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install @google/generative-ai
      
      - name: Run health check
        env:
          GEMINI_API_KEY_FABIAN: ${{ secrets.GEMINI_API_KEY_FABIAN }}
          GEMINI_API_KEY_VICENTE: ${{ secrets.GEMINI_API_KEY_VICENTE }}
        run: node check-health.js
      
      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add status.json history.json
          git commit -m "ðŸ¤– Update health check status [skip ci]" || exit 0
          git push
      
      - name: Generate Status Report
        if: always()
        run: |
          FABIAN_FLASH=$(jq -r '.fabian.flash.status' status.json)
          FABIAN_PRO=$(jq -r '.fabian.pro.status' status.json)
          VICENTE_FLASH=$(jq -r '.vicente.flash.status' status.json)
          VICENTE_PRO=$(jq -r '.vicente.pro.status' status.json)
          
          echo "## ðŸ¤– Gemini API Health Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ‘¤ FabiÃ¡n MuÃ±oz" >> $GITHUB_STEP_SUMMARY
          echo "- Gemini Flash: $([ "$FABIAN_FLASH" == "online" ] && echo 'âœ… Disponible' || echo 'âŒ No disponible')" >> $GITHUB_STEP_SUMMARY
          echo "- Gemini 2.5 Pro: $([ "$FABIAN_PRO" == "online" ] && echo 'âœ… Disponible' || echo 'âŒ No disponible')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ‘¤ Vicente ChacÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "- Gemini Flash: $([ "$VICENTE_FLASH" == "online" ] && echo 'âœ… Disponible' || echo 'âŒ No disponible')" >> $GITHUB_STEP_SUMMARY
          echo "- Gemini 2.5 Pro: $([ "$VICENTE_PRO" == "online" ] && echo 'âœ… Disponible' || echo 'âŒ No disponible')" >> $GITHUB_STEP_SUMMARY
